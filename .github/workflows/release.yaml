name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # ========================================================================
      # Version Calculation
      # ========================================================================
      - name: Get previous version
        id: previous
        run: |
          PREVIOUS=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "version=$PREVIOUS" >> $GITHUB_OUTPUT
          echo "Previous version: $PREVIOUS"

      - name: Determine version bump
        id: bump
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "type=${{ inputs.version_bump }}" >> $GITHUB_OUTPUT
          else
            COMMITS=$(git log ${{ steps.previous.outputs.version }}..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")

            if echo "$COMMITS" | grep -qiE "^(feat|feature)!:|BREAKING CHANGE"; then
              echo "type=major" >> $GITHUB_OUTPUT
            elif echo "$COMMITS" | grep -qiE "^(feat|feature)(\(.+\))?:"; then
              echo "type=minor" >> $GITHUB_OUTPUT
            else
              echo "type=patch" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Calculate new version
        id: version
        run: |
          PREVIOUS="${{ steps.previous.outputs.version }}"
          BUMP="${{ steps.bump.outputs.type }}"

          VERSION=${PREVIOUS#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}

          case $BUMP in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          echo "version=v${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT
          echo "version_num=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT
          echo "New version: v${MAJOR}.${MINOR}.${PATCH}"

      # ========================================================================
      # Update Helm Chart & Create Tag
      # ========================================================================
      - name: Update Helm Chart version
        run: |
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.version_num }}/" helm-chart/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.version_num }}\"/" helm-chart/Chart.yaml

      - name: Commit and Tag
        run: |
          git add helm-chart/Chart.yaml
          git commit -m "chore: release ${{ steps.version.outputs.version }}" || true
          git push origin main || true
          git tag -f ${{ steps.version.outputs.version }}
          git push origin ${{ steps.version.outputs.version }} --force

      # ========================================================================
      # Build and Push Docker Image
      # ========================================================================
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version_num }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ========================================================================
      # Package Helm Chart
      # ========================================================================
      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Package Helm Chart
        run: |
          mkdir -p .helm-releases
          helm package helm-chart -d .helm-releases

      # ========================================================================
      # Create GitHub Release
      # ========================================================================
      - name: Generate Release Body
        id: release_body
        run: |
          PREV="${{ steps.version.outputs.previous }}"
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_NUM="${{ steps.version.outputs.version_num }}"
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"

          {
            echo "## What's Changed"
            echo ""
            if [ "$PREV" != "v0.0.0" ]; then
              git log ${PREV}..HEAD --pretty=format:"- %s (%h)" | head -50
            else
              git log --pretty=format:"- %s (%h)" -20
            fi
            echo ""
            echo ""
            echo "---"
            echo ""
            echo "## Artifacts"
            echo ""
            echo "### Docker Image"
            echo "\`\`\`bash"
            echo "docker pull ${IMAGE}:${VERSION}"
            echo "\`\`\`"
            echo ""
            echo "**Available tags:**"
            echo "- \`${IMAGE}:${VERSION}\`"
            echo "- \`${IMAGE}:${VERSION_NUM}\`"
            echo "- \`${IMAGE}:latest\`"
            echo ""
            echo "### Helm Chart (v${VERSION_NUM})"
            echo "\`\`\`bash"
            echo "helm repo add kibana-sso-proxy https://nativesre.github.io/kibana-sso-proxy"
            echo "helm repo update"
            echo "helm install kibana-sso kibana-sso-proxy/kibana-sso-proxy --version ${VERSION_NUM}"
            echo "\`\`\`"
          } > release_body.md

          echo "Generated release body:"
          cat release_body.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          body_path: release_body.md
          draft: false
          prerelease: false
          make_latest: true
          files: |
            .helm-releases/*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ========================================================================
      # Publish Docs & Helm Chart to GitHub Pages
      # ========================================================================
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Setup and Push to gh-pages
        run: |
          # Initialize gh-pages if needed
          mkdir -p gh-pages

          # Copy documentation
          cp -r docs/* gh-pages/ 2>/dev/null || true

          # Copy Helm chart
          cp .helm-releases/*.tgz gh-pages/ 2>/dev/null || true

          cd gh-pages

          # Generate Helm repo index
          helm repo index . --url https://nativesre.github.io/kibana-sso-proxy || true

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Release ${{ steps.version.outputs.version }}" || true
          git push origin gh-pages --force || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
